# ???????? API ??

## ??
- [????](#????)
- [????](#????)
- [????](#????)
- [????](#????)
- [?? API](#??-api)
- [????](#????)
- [?????](#?????)
- [????](#????)

---

## ????

????????????? React + TypeScript + Vite ?????????????????????K????????????????????

### ???
- **React 18.3+**: UI ??
- **TypeScript 5.5+**: ????
- **Vite 5.4+**: ????
- **Zustand 4.5+**: ????
- **Ant Design 5.20+**: UI ???
- **ECharts 5.5+**: ???
- **Day.js 1.11+**: ????

---

## ????

```json
{
  "antd": "^5.20.7",
  "dayjs": "^1.11.19",
  "echarts": "^5.5.0",
  "immer": "^10.1.1",
  "react": "^18.3.1",
  "zustand": "^4.5.4"
}
```

---

## ????

### Stock
????????

```typescript
interface Stock {
  code: string;        // ?????? "S100000"
  name: string;        // ?????? "??1"
  currentPrice: number; // ????
  change: number;      // ?????????? 1.23 ?? +1.23%
  volume: number;      // ???
}
```

**?????**
```typescript
const stock: Stock = {
  code: 'S100000',
  name: '??1',
  currentPrice: 45.67,
  change: 2.34,
  volume: 150000
};
```

---

### KLineData
K?????????K???

```typescript
interface KLineData {
  date: string;   // ????? yyyy-MM-dd
  open: number;   // ???
  close: number;  // ???
  high: number;   // ???
  low: number;    // ???
  volume: number; // ???
}
```

**?????**
```typescript
const kline: KLineData = {
  date: '2025-11-03',
  open: 45.00,
  close: 46.50,
  high: 47.00,
  low: 44.80,
  volume: 250000
};
```

---

### Transaction
??????

```typescript
interface Transaction {
  id: string;          // ??????
  stockCode: string;   // ????
  type: 'buy' | 'sell'; // ??????????
  price: number;       // ????
  quantity: number;    // ????
  timestamp: string;   // ?????ISO ??????
}
```

**?????**
```typescript
const transaction: Transaction = {
  id: '1730620800000',
  stockCode: 'S100000',
  type: 'buy',
  price: 45.67,
  quantity: 500,
  timestamp: '2025-11-03T10:30:00.000Z'
};
```

---

### Position
??????

```typescript
interface Position {
  stockCode: string;  // ????
  stockName: string;  // ????
  quantity: number;   // ????
  costPrice: number;  // ??????????
}
```

**?????**
```typescript
const position: Position = {
  stockCode: 'S100000',
  stockName: '??1',
  quantity: 1000,
  costPrice: 45.30
};
```

---

### TimePoint
??????????????

```typescript
interface TimePoint {
  time: string;  // ????? HH:mm
  price: number; // ????
  avg: number;   // ??
  vol: number;   // ???
}
```

**?????**
```typescript
const timePoint: TimePoint = {
  time: '10:30',
  price: 45.67,
  avg: 45.50,
  vol: 3500
};
```

---

## ????

### useStockStore

?? Zustand ??????? Hook??????????????????

#### ????

| ?? | ?? | ?? |
|------|------|------|
| `balance` | `number` | ?????????? 100,000 |
| `positions` | `Position[]` | ???? |
| `transactions` | `Transaction[]` | ?????? |
| `stockList` | `Stock[]` | ???? |
| `currentStock` | `Stock \| null` | ??????? |
| `klineData` | `KLineData[]` | ?????K??? |
| `intradayMap` | `Record<string, TimePoint[]>` | ?????????? |
| `openPriceMap` | `Record<string, number>` | ????????? |

#### ?? API

##### init()
???????????????K????????????????

**???**
```typescript
init: () => void
```

**???**
- ?? 25 ?????
- ??????? 90 ?K???
- ???????????
- ?? 8 ???????
- ???????????????????

**?????**
```typescript
import { useStockStore } from '@/stores/useStockStore';

function App() {
  const { init } = useStockStore();
  
  useEffect(() => {
    init(); // ??????????
  }, [init]);
}
```

---

##### setCurrentStock(code)
?????????????????K????

**???**
```typescript
setCurrentStock: (code: string) => void
```

**???**
- `code`: ????

**?????**
```typescript
const { setCurrentStock } = useStockStore();

// ??????? S100001 ???
setCurrentStock('S100001');
```

---

##### buyStock(code, quantity)
?????

**???**
```typescript
buyStock: (code: string, quantity: number) => void
```

**???**
- `code`: ????
- `quantity`: ???????? 100 ?????

**?????**
- ?????0.1%?????? 0.001?
- ?????????
- ????????????????
- ????????

**?????**
```typescript
const { buyStock, balance, stockList } = useStockStore();

// ?? 500 ?
if (balance >= stockList[0].currentPrice * 500 * 1.001) {
  buyStock('S100000', 500);
  console.log('????');
}
```

**???????**
```typescript
// ????? = (????? ? ????? + ????? ? ??????) / ?????
newCostPrice = (oldCostPrice * oldQuantity + currentPrice * quantity) / (oldQuantity + quantity)
```

---

##### sellStock(code, quantity)
?????

**???**
```typescript
sellStock: (code: string, quantity: number) => void
```

**???**
- `code`: ????
- `quantity`: ???????? 100 ?????

**?????**
- ?????0.1%?????? 0.001?
- ?????????
- ???????? 0 ??????????
- ????????

**?????**
```typescript
const { sellStock, positions } = useStockStore();

const position = positions.find(p => p.stockCode === 'S100000');
if (position && position.quantity >= 300) {
  sellStock('S100000', 300);
  console.log('????');
}
```

---

## ?? API

### KLineChart
K????????????????????

**???** `src/components/charts/KLineChart.tsx`

#### Props

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `data` | `KLineData[]` | ? | K????? |

#### ????
- ??????????????????????
- ?? MA5?MA10?MA20 ?????
- ??????????
- ?????????
- ?????? 40% ???
- ???????

#### ????

```typescript
import { KLineChart } from '@/components/charts/KLineChart';
import { useStockStore } from '@/stores/useStockStore';

function TradingView() {
  const { klineData } = useStockStore();
  
  return (
    <div>
      <h2>K??</h2>
      <KLineChart data={klineData} />
    </div>
  );
}
```

#### ??????

**????????**
- MA5?5 ??????
- MA10?10 ??????
- MA20?20 ??????

```typescript
// MA ?????MA5?
function calculateMA5(data: KLineData[], index: number): number {
  if (index < 4) return NaN;
  let sum = 0;
  for (let i = 0; i < 5; i++) {
    sum += data[index - i].close;
  }
  return sum / 5;
}
```

---

### TimeSharingChart
?????????????????????

**???** `src/components/charts/TimeSharingChart.tsx`

#### Props

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `data` | `TimePoint[]` | ? | ?????? |

#### ????
- ??????????
- ??????????
- ?????????
- ????????
- ???????

#### ????

```typescript
import { TimeSharingChart } from '@/components/charts/TimeSharingChart';
import { useStockStore } from '@/stores/useStockStore';

function MarketView() {
  const { currentStock, intradayMap } = useStockStore();
  
  if (!currentStock) return null;
  
  return (
    <div>
      <h2>{currentStock.name} ???</h2>
      <TimeSharingChart data={intradayMap[currentStock.code] || []} />
    </div>
  );
}
```

---

### TradePanel
???????????????????

**???** `src/components/trade/TradePanel.tsx`

#### Props
? Props????? `useStockStore` ?????

#### ????
- ??????????
- ??/????
- ???????1/4?1/2????
- ????????????
- ???????????????
- ?????????

#### ????

```typescript
import { TradePanel } from '@/components/trade/TradePanel';

function TradePage() {
  return (
    <div>
      <h1>????</h1>
      <TradePanel />
    </div>
  );
}
```

#### ????
- ???????100 ?
- ????? 100 ????
- ?????0.1%
- ??????????
- ??????????

---

### PositionList
???????????????????

**???** `src/components/trade/PositionList.tsx`

#### Props
? Props????? `useStockStore` ?????

#### ????
- ????
- ????
- ????
- ???
- ??
- ????

#### ????

```typescript
import { PositionList } from '@/components/trade/PositionList';

function PortfolioPage() {
  return (
    <div>
      <h1>????</h1>
      <PositionList />
    </div>
  );
}
```

#### ????

```typescript
// ???? = (??? - ???) ? ????
const pnl = (currentPrice - costPrice) * quantity;
```

---

### MainLayout
?????????????????????

**???** `src/components/layout/MainLayout.tsx`

#### Props

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `activeKey` | `string` | ? | ???????? key |
| `onChange` | `(key: string) => void` | ? | ???????? |
| `children` | `ReactNode` | ? | ???? |

#### ???
- `market`: ????
- `trade`: ????
- `history`: ??????

#### ????

```typescript
import { MainLayout } from '@/components/layout/MainLayout';
import { useState } from 'react';

function App() {
  const [activeKey, setActiveKey] = useState('market');
  
  return (
    <MainLayout activeKey={activeKey} onChange={setActiveKey}>
      {activeKey === 'market' && <MarketPage />}
      {activeKey === 'trade' && <TradePage />}
      {activeKey === 'history' && <HistoryPage />}
    </MainLayout>
  );
}
```

---

## ????

### ????

**???** `src/utils/calculation.ts`

#### calculateAmount
???????

**???**
```typescript
function calculateAmount(price: number, quantity: number): number
```

**???**
- `price`: ????
- `quantity`: ????

**???**
- ????????????

**?????**
```typescript
import { calculateAmount } from '@/utils/calculation';

const amount = calculateAmount(45.67, 500);
console.log(amount); // 22835.00
```

---

#### calculateFee
????????0.1%??

**???**
```typescript
function calculateFee(amount: number): number
```

**???**
- `amount`: ????

**???**
- ?????????????

**?????**
```typescript
import { calculateFee } from '@/utils/calculation';

const fee = calculateFee(22835.00);
console.log(fee); // 22.84
```

---

#### formatCurrency
????????

**???**
```typescript
function formatCurrency(value: number): string
```

**???**
- `value`: ??

**???**
- ??????????????????????

**?????**
```typescript
import { formatCurrency } from '@/utils/calculation';

console.log(formatCurrency(100000));   // "100,000.00"
console.log(formatCurrency(45.67));    // "45.67"
console.log(formatCurrency(1234567.89)); // "1,234,567.89"
```

---

## ?????

**???** `src/utils/mockData.ts`

### generateStocks
?????????

**???**
```typescript
function generateStocks(count?: number): Stock[]
```

**???**
- `count`: ????????? 25

**???**
- ????

**?????**
```typescript
import { generateStocks } from '@/utils/mockData';

const stocks = generateStocks(10);
console.log(stocks[0]);
// {
//   code: 'S100000',
//   name: '??1',
//   currentPrice: 67.23,
//   change: 2.15,
//   volume: 234567
// }
```

---

### generateKline
??K????

**???**
```typescript
function generateKline(days?: number, basePrice?: number): KLineData[]
```

**???**
- `days`: ??????? 90
- `basePrice`: ??????? 30

**???**
- K?????

**???**
- ????????-6% ~ +6%
- ??????/???? 0~2%
- ??????/???? 0~2%
- ??????100,000 ~ 900,000

**?????**
```typescript
import { generateKline } from '@/utils/mockData';

const klineData = generateKline(30, 50.00);
console.log(klineData.length); // 30
```

---

### generateTransactions
?????????

**???**
```typescript
function generateTransactions(count?: number): Transaction[]
```

**???**
- `count`: ????????? 10

**???**
- ??????

**?????**
```typescript
import { generateTransactions } from '@/utils/mockData';

const transactions = generateTransactions(5);
```

---

### generateIntradaySeries
?????????

**???**
```typescript
function generateIntradaySeries(basePrice: number, minutes?: number): TimePoint[]
```

**???**
- `basePrice`: ????
- `minutes`: ?????? 120

**???**
- ??????

**?????**
```typescript
import { generateIntradaySeries } from '@/utils/mockData';

const intradayData = generateIntradaySeries(45.67, 60);
console.log(intradayData.length); // 60
```

---

### nextIntradayTick
???????????????????

**???**
```typescript
function nextIntradayTick(
  prev: TimePoint[], 
  lastPrice: number
): { series: TimePoint[]; price: number }
```

**???**
- `prev`: ?????????
- `lastPrice`: ??????

**???**
- `series`: ??????????????? 120 ?????
- `price`: ????

**???**
- ??????????0.4%
- ??????
- ???????? 120 ??

**?????**
```typescript
import { nextIntradayTick } from '@/utils/mockData';

const prevData = [/* ... */];
const lastPrice = 45.67;

const { series, price } = nextIntradayTick(prevData, lastPrice);
console.log(price); // 45.72 (??)
```

---

## ????

### ????????

```typescript
import { useEffect } from 'react';
import { useStockStore } from '@/stores/useStockStore';
import { calculateAmount, calculateFee } from '@/utils/calculation';

function TradingExample() {
  const {
    init,
    stockList,
    balance,
    positions,
    buyStock,
    sellStock,
    setCurrentStock
  } = useStockStore();

  // 1. ?????
  useEffect(() => {
    init();
  }, [init]);

  // 2. ????
  const selectStock = () => {
    if (stockList.length > 0) {
      setCurrentStock(stockList[0].code);
    }
  };

  // 3. ????
  const handleBuy = () => {
    const stock = stockList[0];
    if (!stock) return;

    const quantity = 500; // ?? 500 ?
    const amount = calculateAmount(stock.currentPrice, quantity);
    const fee = calculateFee(amount);
    const total = amount + fee;

    if (balance >= total) {
      buyStock(stock.code, quantity);
      console.log(`?????${stock.name} ? ${quantity} ?`);
    } else {
      console.log('????');
    }
  };

  // 4. ????
  const handleSell = () => {
    const position = positions[0];
    if (!position) {
      console.log('???');
      return;
    }

    const quantity = 300; // ?? 300 ?
    if (position.quantity >= quantity) {
      sellStock(position.stockCode, quantity);
      console.log(`?????${position.stockName} ? ${quantity} ?`);
    } else {
      console.log('????');
    }
  };

  return (
    <div>
      <button onClick={selectStock}>????</button>
      <button onClick={handleBuy}>??</button>
      <button onClick={handleSell}>??</button>
    </div>
  );
}
```

---

### ???????

```typescript
import { KLineChart } from '@/components/charts/KLineChart';
import { TimeSharingChart } from '@/components/charts/TimeSharingChart';
import { generateKline, generateIntradaySeries } from '@/utils/mockData';

function CustomChartExample() {
  // ?????K???
  const klineData = generateKline(60, 100.00);
  
  // ?????????
  const intradayData = generateIntradaySeries(100.00, 240);

  return (
    <div>
      <div>
        <h3>K??</h3>
        <KLineChart data={klineData} />
      </div>
      <div>
        <h3>???</h3>
        <TimeSharingChart data={intradayData} />
      </div>
    </div>
  );
}
```

---

### ????????

```typescript
import { useStockStore } from '@/stores/useStockStore';

function PortfolioAnalysis() {
  const { positions, stockList } = useStockStore();

  const calculatePnL = () => {
    let totalPnL = 0;
    
    positions.forEach(position => {
      const stock = stockList.find(s => s.code === position.stockCode);
      if (stock) {
        const pnl = (stock.currentPrice - position.costPrice) * position.quantity;
        totalPnL += pnl;
        
        console.log(`${position.stockName}: ${pnl.toFixed(2)} ?`);
      }
    });
    
    console.log(`???: ${totalPnL.toFixed(2)} ?`);
    return totalPnL;
  };

  return (
    <div>
      <button onClick={calculatePnL}>????</button>
    </div>
  );
}
```

---

### ????????

```typescript
import { useEffect, useState } from 'react';
import { useStockStore } from '@/stores/useStockStore';

function RealtimeDataExample() {
  const { init, stockList, currentStock } = useStockStore();
  const [priceHistory, setPriceHistory] = useState<number[]>([]);

  // ???
  useEffect(() => {
    init();
  }, [init]);

  // ??????
  useEffect(() => {
    if (currentStock) {
      setPriceHistory(prev => [...prev, currentStock.currentPrice]);
      console.log(`????: ${currentStock.currentPrice}`);
    }
  }, [currentStock?.currentPrice]);

  return (
    <div>
      <h3>??????</h3>
      {currentStock && (
        <div>
          <p>????: {currentStock.name}</p>
          <p>????: ?{currentStock.currentPrice.toFixed(2)}</p>
          <p>???: {currentStock.change.toFixed(2)}%</p>
          <p>????: {priceHistory.slice(-10).join(', ')}</p>
        </div>
      )}
    </div>
  );
}
```

---

## ????

### 1. ????
```typescript
// ? ????????? selector ????
const balance = useStockStore(state => state.balance);
const buyStock = useStockStore(state => state.buyStock);

// ? ???????? store
const store = useStockStore();
```

### 2. ????
```typescript
// ? ????????????
function safeBuyStock(code: string, quantity: number) {
  const { stockList, balance, buyStock } = useStockStore.getState();
  
  // ??????
  const stock = stockList.find(s => s.code === code);
  if (!stock) {
    console.error('?????');
    return false;
  }
  
  // ????
  if (quantity <= 0 || quantity % 100 !== 0) {
    console.error('????? 100 ?????');
    return false;
  }
  
  // ????
  const amount = calculateAmount(stock.currentPrice, quantity);
  const fee = calculateFee(amount);
  if (balance < amount + fee) {
    console.error('????');
    return false;
  }
  
  buyStock(code, quantity);
  return true;
}
```

### 3. ??????
```typescript
// ? ????? useMemo ??????
const chartData = useMemo(() => {
  return klineData.map(/* ???? */);
}, [klineData]);

// ? ????????
useEffect(() => {
  const timer = setInterval(/* ... */, 1000);
  return () => clearInterval(timer);
}, []);
```

---

## ????

### Q1: ?????????
? `useStockStore` ? `buyStock` ? `sellStock` ????? `0.001` ?????

### Q2: ?????????
?? `generateStocks(count)` ???????????

### Q3: ???????????
? `useStockStore` ? `init` ????? `setInterval` ????????? 1000ms??

### Q4: ????????
???? Zustand ? `persist` ????
```typescript
import { persist } from 'zustand/middleware';

export const useStockStore = create<StockStore>()(
  persist(
    immer((set, get) => ({ /* ... */ })),
    { name: 'stock-store' }
  )
);
```

---

## ????

- **v0.1.0** (2025-11-03)
  - ????
  - ??????
  - K??????
  - ??????

---

## ???

???????????????????

---

## ????

???????????????? Issues ?????
