# ???????? API ??

??????????????????? API??????????????????????

## ??

1. [????](#????)
2. [???? Store](#????-store)
3. [????](#????)
4. [??](#??)
   - [????](#????)
   - [????](#????)
   - [????](#????)
   - [????](#????)

---

## ????

???????? `src/types/stock.ts`?

### Stock

?????????

```typescript
interface Stock {
  code: string;        // ??????? "S100000"
  name: string;        // ??????? "??1"
  currentPrice: number; // ???????
  change: number;      // ??????????? 1.23 ?? +1.23%
  volume: number;      // ??????
}
```

**???**
```typescript
const stock: Stock = {
  code: 'S100000',
  name: '??1',
  currentPrice: 45.67,
  change: 2.35,
  volume: 125000
};
```

---

### KLineData

K??????

```typescript
interface KLineData {
  date: string;    // ????? "yyyy-MM-dd"
  open: number;    // ???
  close: number;   // ???
  high: number;    // ???
  low: number;     // ???
  volume: number;  // ???
}
```

**???**
```typescript
const kline: KLineData = {
  date: '2024-01-15',
  open: 45.00,
  close: 45.67,
  high: 46.20,
  low: 44.80,
  volume: 1250000
};
```

---

### Transaction

???????

```typescript
interface Transaction {
  id: string;              // ?????
  stockCode: string;       // ????
  type: 'buy' | 'sell';    // ??????????
  price: number;           // ????
  quantity: number;        // ???????
  timestamp: string;       // ISO ?????
}
```

**???**
```typescript
const transaction: Transaction = {
  id: '1705123456789',
  stockCode: 'S100000',
  type: 'buy',
  price: 45.67,
  quantity: 100,
  timestamp: '2024-01-15T10:30:00.000Z'
};
```

---

### Position

???????

```typescript
interface Position {
  stockCode: string;   // ????
  stockName: string;   // ????
  quantity: number;    // ???????
  costPrice: number;   // ??????
}
```

**???**
```typescript
const position: Position = {
  stockCode: 'S100000',
  stockName: '??1',
  quantity: 500,
  costPrice: 45.50
};
```

---

### TimePoint

????????

```typescript
interface TimePoint {
  time: string;  // ????? "HH:mm"
  price: number; // ??
  avg: number;   // ??
  vol: number;   // ???
}
```

**???**
```typescript
const timePoint: TimePoint = {
  time: '10:30',
  price: 45.67,
  avg: 45.50,
  vol: 5000
};
```

---

## ???? Store

### useStockStore

?? Zustand ???????????? `immer` ???????????

**???**
```typescript
import { useStockStore } from '@/stores/useStockStore';
```

#### ????

| ?? | ?? | ?? |
|------|------|------|
| `balance` | `number` | ??????????? 100000 |
| `positions` | `Position[]` | ?????? |
| `transactions` | `Transaction[]` | ?????? |
| `stockList` | `Stock[]` | ???? |
| `currentStock` | `Stock \| null` | ??????? |
| `klineData` | `KLineData[]` | K????? |
| `intradayMap` | `Record<string, TimePoint[]>` | ?????????? |
| `openPriceMap` | `Record<string, number>` | ????????? |

#### ??

##### init()

???????????????

```typescript
init(): void
```

**???**
- ????????? 25 ??
- ?? K ?????? 90 ??
- ??????
- ????????
- ??????? 1 ???????

**???**
```typescript
function MyComponent() {
  const { init } = useStockStore();
  
  useEffect(() => {
    init();
  }, [init]);
  
  return <div>...</div>;
}
```

**?????**
- ???? `init()` ?????????????????
- ???????????

---

##### setCurrentStock(code: string)

??????????

```typescript
setCurrentStock(code: string): void
```

**???**
- `code: string` - ????

**???**
- ??????????
- ?? `currentStock`
- ????????? K ???

**???**
```typescript
function StockSelector() {
  const { stockList, setCurrentStock } = useStockStore();
  
  return (
    <Select onChange={(code) => setCurrentStock(code)}>
      {stockList.map(stock => (
        <Option key={stock.code} value={stock.code}>
          {stock.code} {stock.name}
        </Option>
      ))}
    </Select>
  );
}
```

**?????**
- ????????????????????????
- ????????? K ???

---

##### buyStock(code: string, quantity: number)

?????

```typescript
buyStock(code: string, quantity: number): void
```

**???**
- `code: string` - ????
- `quantity: number` - ??????????? 100 ????

**???**
- ?????????????? 0.1%?
- ??????
- ???????????????????????
- ??????

**?????**
```
???? = ???? ? ??
??? = ???? ? 0.001
??? = ???? + ???
???? = (???? ? ??? + ???? ? ????) / ???
```

**???**
```typescript
function BuyButton() {
  const { currentStock, balance, buyStock } = useStockStore();
  
  const handleBuy = () => {
    if (!currentStock) return;
    const quantity = 100;
    const amount = currentStock.currentPrice * quantity;
    const fee = amount * 0.001;
    const total = amount + fee;
    
    if (balance < total) {
      alert('????');
      return;
    }
    
    buyStock(currentStock.code, quantity);
  };
  
  return <Button onClick={handleBuy}>??</Button>;
}
```

**?????**
- ????????????????????
- ???????????????????
- ????? 100 ????

---

##### sellStock(code: string, quantity: number)

?????

```typescript
sellStock(code: string, quantity: number): void
```

**???**
- `code: string` - ????
- `quantity: number` - ???????

**???**
- ????????
- ???????????? 0 ??????
- ?????????????
- ??????

**?????**
```
???? = ???? ? ??
??? = ???? ? 0.001
???? = ???? - ???
```

**???**
```typescript
function SellButton() {
  const { currentStock, positions, sellStock } = useStockStore();
  
  const handleSell = () => {
    if (!currentStock) return;
    const position = positions.find(p => p.stockCode === currentStock.code);
    
    if (!position || position.quantity < 100) {
      alert('????');
      return;
    }
    
    sellStock(currentStock.code, 100);
  };
  
  return <Button onClick={handleSell}>??</Button>;
}
```

**?????**
- ?????????????????????????
- ????????????
- ???????? 0 ?????????????

---

#### ??????

```typescript
import { useStockStore } from '@/stores/useStockStore';

function TradingComponent() {
  const {
    balance,
    positions,
    transactions,
    stockList,
    currentStock,
    klineData,
    setCurrentStock,
    buyStock,
    sellStock,
    init
  } = useStockStore();
  
  useEffect(() => {
    init();
  }, [init]);
  
  return (
    <div>
      <p>??: ?{balance.toFixed(2)}</p>
      <p>???: {positions.length}</p>
      <p>????: {currentStock?.name}</p>
      
      <button onClick={() => buyStock('S100000', 100)}>
        ?? S100000
      </button>
      
      <button onClick={() => sellStock('S100000', 100)}>
        ?? S100000
      </button>
    </div>
  );
}
```

---

## ????

### ???? (calculation.ts)

#### calculateAmount(price: number, quantity: number): number

???????

```typescript
function calculateAmount(price: number, quantity: number): number
```

**???**
- `price: number` - ??
- `quantity: number` - ??

**????**
- `number` - ????????????

**???**
```typescript
import { calculateAmount } from '@/utils/calculation';

const amount = calculateAmount(45.67, 100);
// ??: 4567.00
```

---

#### calculateFee(amount: number): number

??????

```typescript
function calculateFee(amount: number): number
```

**???**
- `amount: number` - ????

**????**
- `number` - ????????? 0.1%????????

**???**
```typescript
import { calculateFee } from '@/utils/calculation';

const fee = calculateFee(4567.00);
// ??: 4.57 (4567.00 * 0.001)
```

---

#### formatCurrency(value: number): string

????????

```typescript
function formatCurrency(value: number): string
```

**???**
- `value: number` - ??

**????**
- `string` - ??????????????????????

**???**
```typescript
import { formatCurrency } from '@/utils/calculation';

const formatted = formatCurrency(1234567.89);
// ??: "1,234,567.89"
```

---

### Mock ?????? (mockData.ts)

?????????????????????

#### generateStocks(count?: number): Stock[]

???????

```typescript
function generateStocks(count?: number): Stock[]
```

**???**
- `count?: number` - ??????? 25

**????**
- `Stock[]` - ????

**???**
```typescript
import { generateStocks } from '@/utils/mockData';

const stocks = generateStocks(10);
// ?? 10 ??????? S100000 ??
```

**????????**
- ?????`S100000`, `S100001`, ...
- ?????`??1`, `??2`, ...
- ?????5 - 150 ?
- ??????-5% ? +5%
- ??????10000 - 500000

---

#### generateKline(days?: number, basePrice?: number): KLineData[]

?? K ????

```typescript
function generateKline(days?: number, basePrice?: number): KLineData[]
```

**???**
- `days?: number` - ????? 90
- `basePrice?: number` - ??????? 30

**????**
- `KLineData[]` - K ????????????????

**???**
```typescript
import { generateKline } from '@/utils/mockData';

const klineData = generateKline(30, 50);
// ?? 30 ?? K ????? 50 ???
```

**?????**
- ?????????????????? -6% ? +6%
- ?????????????????????? 0-2%
- ??????100000 - 900000

---

#### generateTransactions(count?: number): Transaction[]

???????

```typescript
function generateTransactions(count?: number): Transaction[]
```

**???**
- `count?: number` - ??????? 10

**????**
- `Transaction[]` - ??????

**???**
```typescript
import { generateTransactions } from '@/utils/mockData';

const transactions = generateTransactions(20);
// ?? 20 ?????
```

---

#### generateIntradaySeries(basePrice: number, minutes?: number): TimePoint[]

?????????

```typescript
function generateIntradaySeries(basePrice: number, minutes?: number): TimePoint[]
```

**???**
- `basePrice: number` - ????
- `minutes?: number` - ?????? 120

**????**
- `TimePoint[]` - ???????

**???**
```typescript
import { generateIntradaySeries } from '@/utils/mockData';

const series = generateIntradaySeries(45.67, 240);
// ?? 240 ????????????????
```

**?????**
- ?????????????? ?0.2%
- ???????
- ??????1000 - 6000

---

#### nextIntradayTick(prev: TimePoint[], lastPrice: number): { series: TimePoint[]; price: number }

???????????

```typescript
function nextIntradayTick(
  prev: TimePoint[], 
  lastPrice: number
): { series: TimePoint[]; price: number }
```

**???**
- `prev: TimePoint[]` - ?????????????? 119 ???
- `lastPrice: number` - ??????

**????**
- `{ series: TimePoint[]; price: number }` - ???????????

**???**
```typescript
import { nextIntradayTick } from '@/utils/mockData';

const current = nextIntradayTick(existingSeries, 45.67);
// current.series: ????????? 120 ???
// current.price: ????
```

**?????**
- ?????????????
- ??????????????? 120 ??????
- ????????0.2%

---

## ??

### ????

#### MainLayout

????????????????

**???**
```typescript
import { MainLayout } from '@/components/layout/MainLayout';
```

**Props?**

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `activeKey` | `string` | ? | ?????????? |
| `onChange` | `(key: string) => void` | ? | ?????? |
| `children` | `ReactNode` | ? | ????? |

**???**
- ???????
- ????????????????????
- ???????

**???**
```typescript
import { MainLayout } from '@/components/layout/MainLayout';
import { useState } from 'react';

function App() {
  const [activeKey, setActiveKey] = useState('market');
  
  return (
    <MainLayout 
      activeKey={activeKey} 
      onChange={(key) => setActiveKey(key)}
    >
      {activeKey === 'market' && <MarketPage />}
      {activeKey === 'trade' && <TradePage />}
      {activeKey === 'history' && <HistoryPage />}
    </MainLayout>
  );
}
```

**????????**
- `'market'` - ????
- `'trade'` - ????
- `'history'` - ??????

---

### ????

#### KLineChart

K ??????? ECharts ????? K ????

**???**
```typescript
import { KLineChart } from '@/components/charts/KLineChart';
```

**Props?**

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `data` | `KLineData[]` | ? | K ????? |

**???**
- ?? K ???????
- ?? MA5?MA10?MA20 ??
- ????????????
- ??????
- ???????
- ??????????

**???**
```typescript
import { KLineChart } from '@/components/charts/KLineChart';
import { useStockStore } from '@/stores/useStockStore';

function ChartExample() {
  const { klineData } = useStockStore();
  
  return (
    <div style={{ width: '100%', height: '400px' }}>
      <KLineChart data={klineData} />
    </div>
  );
}
```

**?????**
- **???** K ? + MA5/MA10/MA20 ??
- **???** ??????
- **???** ??????????????????

**?????**
- ??????????????
- ???? `.chart-container` ????????

---

#### TimeSharingChart

???????????????

**???**
```typescript
import { TimeSharingChart } from '@/components/charts/TimeSharingChart';
```

**Props?**

| ?? | ?? | ?? | ?? |
|------|------|------|------|
| `data` | `TimePoint[]` | ? | ??????? |

**???**
- ????????????
- ?????????
- ????????????
- ??????
- ???????
- ??????????

**???**
```typescript
import { TimeSharingChart } from '@/components/charts/TimeSharingChart';
import { useStockStore } from '@/stores/useStockStore';

function ChartExample() {
  const { currentStock, intradayMap } = useStockStore();
  
  return (
    <div style={{ width: '100%', height: '400px' }}>
      {currentStock && (
        <TimeSharingChart 
          data={intradayMap[currentStock.code] || []} 
        />
      )}
    </div>
  );
}
```

**?????**
- **???** ????????+ ???????
- **???** ??????
- **???** ??????????????????

**?????**
- ??????????????
- ???? `.chart-container` ????????

---

### ????

#### TradePanel

??????????????????

**???**
```typescript
import { TradePanel } from '@/components/trade/TradePanel';
```

**Props?** ?

**???**
- ???????
- ??/????
- ???????????1/4?1/2????
- ?????????????????
- ???????????????
- ???????

**???**
```typescript
import { TradePanel } from '@/components/trade/TradePanel';

function TradePage() {
  return (
    <div>
      <TradePanel />
    </div>
  );
}
```

**?????**

1. **?????**
   - ??????????????
   - ??????

2. **???????**
   - ??"??"?"??"????

3. **?????**
   - ??????????????? 100 ?????
   - ????????1/4?1/2???
   - ????"??"???????????????
   - ????"??"?????????

4. **?????**
   - ??"????"?"????"??
   - ????????
     - ????????????? 100 ?????
     - ??????????
     - ??????????

**????????**
- ??????????
- ????????????????????
- ????
- ????
- ????0.1%?
- ????? = ?? + ?????? = ?? - ????

**?????**
- ????? 100 ????
- ?????????????????????
- ??????????????

---

#### PositionList

???????????????????

**???**
```typescript
import { PositionList } from '@/components/trade/PositionList';
```

**Props?** ?

**???**
- ????????
- ???????????
- ???????????????????????????

**???**
```typescript
import { PositionList } from '@/components/trade/PositionList';

function TradePage() {
  return (
    <div>
      <TradePanel />
      <PositionList />
    </div>
  );
}
```

**?????**

| ?? | ?? |
|------|------|
| ?? | ???? |
| ?? | ???? |
| ?? | ??????? |
| ??? | ???????? |
| ?? | ?????????????? |
| ???? | ?????????????(?? - ???) ? ?? |

**?????**
- ???????????????
- ????????????????? 0
- ??????????

---

### ????

#### MarketPage

????????????????

**???**
```typescript
import { MarketPage } from '@/components/pages/MarketPage';
```

**Props?** ?

**???**
- ????????????
- ????????????
- ?????????/???
- ?????????

**???**
```typescript
import { MarketPage } from '@/components/pages/MarketPage';

function App() {
  return <MarketPage />;
}
```

**?????**

1. **??????**
   - ????????????????
   - ?????????????????????

2. **???????**
   - ?"????"?????????
   - ??????????????????

3. **?????**
   - ??????????
   - ??????????????????

4. **?????**
   - ?????????
   - ????????????

**?????**
- ?????????? `useStockStore().init()` ?????
- ???????????? 1 ??

---

#### TradePage

??????? K ?????????????

**???**
```typescript
import { TradePage } from '@/components/pages/TradePage';
```

**Props?** ?

**???**
- ????????? K ??
- ????????
- ??????

**???**
```typescript
import { TradePage } from '@/components/pages/TradePage';

function App() {
  return <TradePage />;
}
```

**?????**
- ???16 ???K ??
- ???8 ???????
- ???????????

**?????**

1. **?? K ???**
   - ??????????? K ??
   - ?? MA5?MA10?MA20 ??????

2. **?????**
   - ??????????/????
   - ???????? [TradePanel](#tradepanel) ????

3. **?????**
   - ??????????
   - ?????????????
   - ????????

**?????**
- ?????????? `useStockStore().init()` ?????
- K ???????????????
- ?????????????????

---

#### HistoryPage

??????????????????

**???**
```typescript
import { HistoryPage } from '@/components/pages/HistoryPage';
```

**Props?** ?

**???**
- ????????
- ???????
- ?????????????????????

**???**
```typescript
import { HistoryPage } from '@/components/pages/HistoryPage';

function App() {
  return <HistoryPage />;
}
```

**?????**

1. **???????**
   - ??????????
   - ???????????????
   - ???? 10 ???

2. **??????**
   - ?????????????
   - ??????????????
   - ??????????????

**?????**

| ?? | ?? |
|------|------|
| ?? | ?????ISO ??????????? |
| ?? | ???? |
| ?? | buy????? sell???? |
| ?? | ??????? |
| ?? | ??????? |

**?????**
- ?????????? `useStockStore().init()` ?????
- ???????/????????
- ????????????????????

---

## ??????

### ??????

```typescript
// App.tsx
import { useState } from 'react';
import { MainLayout } from './components/layout/MainLayout';
import { MarketPage } from './pages/MarketPage';
import { TradePage } from './pages/TradePage';
import { HistoryPage } from './pages/HistoryPage';

export default function App() {
  const [activeKey, setActiveKey] = useState('market');

  return (
    <MainLayout
      activeKey={activeKey}
      onChange={(key) => setActiveKey(key)}
    >
      {activeKey === 'market' && <MarketPage />}
      {activeKey === 'trade' && <TradePage />}
      {activeKey === 'history' && <HistoryPage />}
    </MainLayout>
  );
}
```

### ???????

```typescript
import { useStockStore } from '@/stores/useStockStore';
import { Button, message } from 'antd';

function CustomTrading() {
  const { 
    currentStock, 
    balance, 
    positions, 
    buyStock, 
    sellStock 
  } = useStockStore();

  const handleQuickBuy = () => {
    if (!currentStock) {
      message.warning('??????');
      return;
    }

    // ???????????????100?????
    const maxQuantity = Math.floor(
      (balance / (currentStock.currentPrice * 1.001)) / 100
    ) * 100;

    if (maxQuantity < 100) {
      message.error('?????????');
      return;
    }

    buyStock(currentStock.code, maxQuantity);
    message.success(`?? ${currentStock.name} ${maxQuantity} ?`);
  };

  const handleQuickSell = () => {
    if (!currentStock) {
      message.warning('??????');
      return;
    }

    const position = positions.find(
      p => p.stockCode === currentStock.code
    );

    if (!position || position.quantity === 0) {
      message.warning('????');
      return;
    }

    sellStock(currentStock.code, position.quantity);
    message.success(`?? ${currentStock.name} ${position.quantity} ?`);
  };

  return (
    <div>
      <p>????: {currentStock?.name}</p>
      <p>????: ?{balance.toFixed(2)}</p>
      
      <Button onClick={handleQuickBuy}>????????</Button>
      <Button onClick={handleQuickSell}>????????</Button>
    </div>
  );
}
```

### ???????

```typescript
import { useEffect } from 'react';
import { useStockStore } from '@/stores/useStockStore';
import { KLineChart } from '@/components/charts/KLineChart';

function CustomChartView() {
  const { 
    currentStock, 
    klineData, 
    setCurrentStock,
    stockList 
  } = useStockStore();

  useEffect(() => {
    // ?????????
    if (stockList.length > 0 && !currentStock) {
      setCurrentStock(stockList[0].code);
    }
  }, [stockList, currentStock, setCurrentStock]);

  if (!klineData.length) {
    return <div>???...</div>;
  }

  return (
    <div>
      <h2>{currentStock?.name} K??</h2>
      <div style={{ width: '100%', height: '500px' }}>
        <KLineChart data={klineData} />
      </div>
    </div>
  );
}
```

---

## ????

### 1. ????

- ?? `useStockStore` hook ?????????
- ?????????? store ??????????
- ???????? `init()` ?????

### 2. ????

- ????? `buyStock` ? `sellStock` ?????
- ???????????????????
- ?? `message` ?????????

### 3. ????

- ????????????
- ????????????????????
- K????????????????????

### 4. ????

- ?? `useMemo` ??????
- ??????????????
- ??????????????????

### 5. ????

- ????????????`yyyy-MM-dd`????`HH:mm`?
- ???????????
- ????? 100 ????

---

## ????

### Q: ?????/?????????

A: ???????
1. ????????`currentStock` ?? null?
2. ???????????
3. ???????????????
4. ????? 100 ????
5. ???????????????

### Q: ???????????

A: ???????
1. ????? `data` ?????
2. ????????????? CSS ??????
3. ??????????
4. ????????????

### Q: ??????

A: ????? `init()` ???????????????????

### Q: ?????????

A: ?????????????? `generateStocks()` ???????????????
1. ?? `mockData.ts` ?? `generateStocks` ??
2. ???????????? `stockList`

---

## ????

- **?????** ????????
- **???** 0.1.0
- **????** React 18 + TypeScript + Ant Design 5 + ECharts 5 + Zustand

---

## ????

### v0.1.0
- ????
- ???????????
- ?? K ??????
- ???????????

---

*???????2024-01-15*
